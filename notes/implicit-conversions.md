# 暗黙の型変換

暗黙の型変換とは、ある型から別の型への変換処理を事前に用意しておく事で、
実際の変換処理を明示的に記述する事なく型変換を行う方法である。
暗黙の型変換を使えば、普通なら型の不一致としてコンパイルエラーになるようなコードを
記述できるようになる。これは例えば、異なる既存のライブラリ同士を使用したコードを
変換メソッドやラッパークラスを用いる事なく記述するのに役に立つ。

例えば、[Rationalクラス](../src/Rational.scala)をInt型と併用する事を考えてみる。
Rationalクラス内でメソッドを定義すれば、RationalのインスタンスにInt型の値を
足したり引いたりする事はできる。しかし逆に、Int型の値に対してRational型の値を
演算する事はできない。各演算子はInt型のメソッドとして定義されており、当然そこには
Rational型用のオーバーロードメソッドなど存在しないからである。

```scala
// Can be compiled.
val oneHalf = new Raitonal(1, 2)
val one = oneHalf + oneHalf
val two = oneHalf * 4

// Compile error.
val three = 6 * oneHalf
```

このような場合、通常なら先にInt型をRational型に変換するか、あるいは動的な言語であれば
モンキーパッチとしてInt型にRational型用のメソッドを追加するなどの方法がある。Scalaでは、
この問題を暗黙の型変換を定義する事で解決する。

```scala
implicit def intToRational(x: Int) =
  new Rational(x, 1)
```

Scalaコンパイラは型変換できないコードに出くわすと、エラーを投げる前に`implicit`キーワードが
付与された暗黙の型変換メソッドを探し、求められている型に合致するものがあればそれを暗黙の内に
使用して型の不一致を解決する。

## 暗黙の型変換のルール

暗黙の型変換メソッドは、以下のルールに則って探され、適用される。

1. `implicit`によって修飾されたメソッドのみが暗黙の型変換に使用できる。
2. 以下のどちらかを満たす型変換メソッドのみが使用される。
    * 変換対象の式と同じスコープ内で単一の識別子として定義されている
    (よって別パッケージなどにある変換メソッドを使用したければ、それを単一の識別子で使用できるように
    `import`する必要がある)。
    * 変換前もしくは変換後の型のコンパニオンオブジェクト内で定義されている。
3. 1つの式に対して、暗黙の型変換が2つ以上同時に適用される事はない。
4. 書かれたままの状態でコードが型チェックをパスする時には、暗黙の型変換は行われない。
5. 適用可能な型変換メソッドが複数見つかった場合、その中で最も型が限定的なメソッドが選択される。

型変換が適用される場所は以下の3つである。

1. 要求された型への変換( `val i: Int = 3.5` -> `val i: Int = doubleToInt(3.5)` )
2. レシーバの変換( `obj.doIt` -> `objToSome(obj).doIt`)
3. 暗黙のパラメータ( 後述 )

## 暗黙のパラメータ

カリー化されたメソッドを呼び出す際、カリー化された最後のパラメータリスト全体を
暗黙の型変換によって省略する事ができる([例](../src/implicitParameters.scala))。
この場合、パラメータリストと暗黙的に渡したい値の`val`や`var`宣言双方に`implicit`修飾子が
付与されていなければならない。この補完はパラメータリストにマッチする型を探して行われるので、
暗黙のパラメータを使用する場合は`String`などの汎用的な型ではなく専用の型を使う方が良い。

### 可視境界を用いたパラメータ

例えば上限境界を使って定義された`T <: Ordered[T]`の場合、`T`は`Ordered`のサブ型である必要があり、
`Int`などそうでない型は適用できない。しかし可視境界を使った`T <% Ordered[T]`であれば、
`T`は「Ordered[T]**として扱える**任意の型」となる。つまり暗黙の型変換によって変換可能である全ての型に
当てはまる。Scalaは`Int`などの一般的な型を`Ordered[T]`に変換する暗黙のメソッドを定義しているため、
この可視境界を使用してメソッドを定義すれば、`Int`などの型でも受け取れるようになる。当然、メソッド内部で明示的に
`Ordered`へ変換するような処理は必要ない([例](../src/implicitParameters.scala))。

